variables:
  CI_REGISTRY: "registry.gitlab.com"
  PROJECT_REGISTRY: "$CI_REGISTRY/hmajid2301/gitlab-auto-mr"
  DOCKER_DRIVER: overlay2

image: python:3.6

services:
  - docker:dind

stages:
  - test
  - publish


publish-package:test:
  stage: test
  only:
    - master
  variables:
    TWINE_USERNAME: $PYPI_STAGING_USERNAME
    TWINE_PASSWORD: $PYPI_STAGING_PASSWORD
  before_script:
    - pip install twine
    - python setup.py sdist
  script:
    - twine check dist/*
    - twine upload --repository-url https://test.pypi.org/legacy/ dist/*


publish-package:production:
  stage: publish
  only:
    - /^release/.*$/
  variables:
    TWINE_USERNAME: $PYPI_PRODUCTION_USERNAME
    TWINE_PASSWORD: $PYPI_PRODUCTION_PASSWORD
  before_script:
    - pip install twine
    - python setup.py sdist
  script:
    - twine check dist/*
    - twine upload dist/*


publish-docker:
  stage: publish
  only:
    - /^release/.*$/
  image: docker
  before_script:
    - apk add python
    - python setup.py sdist
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${PROJECT_REGISTRY}:latest  .
    - docker push ${PROJECT_REGISTRY}:latest


